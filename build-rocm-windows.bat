@echo off
setlocal enabledelayedexpansion

REM Build script for comfy-aimdo on Windows ROCm
REM
REM Requirements:
REM   - ROCm SDK installed via pip (_rocm_sdk_core)
REM   - CUDA toolkit installed (used only as a hipify reference, not for compilation)
REM   - Visual Studio 2022 with C++ workload

echo ============================================
echo   Building comfy-aimdo for Windows ROCm
echo ============================================
echo.

REM ---- Prompt for paths ----
echo Enter the path to your ROCm SDK core directory.
echo This is typically inside your venv, e.g.:
echo   C:\ComfyUI\venv\Lib\site-packages\_rocm_sdk_core
echo.
set /p ROCM_PATH="ROCm SDK path: "

echo.
echo Enter the path to your CUDA toolkit installation, e.g.:
echo   C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.9
echo.
set /p CUDA_ORIG="CUDA path: "

echo.

REM ---- Validate inputs ----
if not exist "%ROCM_PATH%" (
    echo ERROR: ROCm path not found: %ROCM_PATH%
    exit /b 1
)
if not exist "%CUDA_ORIG%" (
    echo ERROR: CUDA path not found: %CUDA_ORIG%
    exit /b 1
)

REM ---- Derive paths ----
set ROCM_CLANG=%ROCM_PATH%\lib\llvm\lib\clang
set CLANG_EXE=%ROCM_PATH%\lib\llvm\bin\clang.exe
set LLDLINK_EXE=%ROCM_PATH%\lib\llvm\bin\lld-link.exe
set HIP_INCLUDE=%ROCM_PATH%\include
set HIP_LIB=%ROCM_PATH%\lib

for /d %%i in ("%ROCM_CLANG%\*") do set CLANG_RESOURCE_DIR=%%i

if not defined CLANG_RESOURCE_DIR (
    echo ERROR: Could not find clang version directory under %ROCM_CLANG%
    exit /b 1
)
if not exist "%CLANG_EXE%" (
    echo ERROR: clang.exe not found at %CLANG_EXE%
    exit /b 1
)

echo ROCm path:  %ROCM_PATH%
echo CUDA path:  %CUDA_ORIG%
echo Clang:      %CLANG_EXE%
echo Clang dir:  %CLANG_RESOURCE_DIR%
echo.

REM ---- CUDA junction (hipify needs a path without spaces) ----
set CUDA_LINK=%TEMP%\cuda_hip_%RANDOM%%RANDOM%
mklink /J "%CUDA_LINK%" "%CUDA_ORIG%" >nul 2>nul
if not exist "%CUDA_LINK%" (
    echo ERROR: Failed to create junction at %CUDA_LINK%
    exit /b 1
)

REM ---- Pre-build Cleanup & Copy ----
if exist hip_src rmdir /S /Q hip_src
if exist build rmdir /S /Q build
if exist comfy_aimdo.egg-info rmdir /S /Q comfy_aimdo.egg-info
if exist comfy_aimdo\_version.py del /F /Q comfy_aimdo\_version.py
if exist comfy_aimdo\aimdo.dll del /F /Q comfy_aimdo\aimdo.dll
if exist comfy_aimdo\aimdo.lib del /F /Q comfy_aimdo\aimdo.lib
mkdir hip_src
copy src\*.c hip_src\ >nul
copy src\*.h hip_src\ >nul
if exist src-win\ (
    copy src-win\*.c hip_src\ >nul
    copy src-win\*.h hip_src\ >nul
)
REM cuda-detour.c requires Microsoft Detours which is CUDA-only â€” replace with ROCm stub
if exist hip_src\cuda-detour.c del /F /Q hip_src\cuda-detour.c

set HIPIFY_EXE=%ROCM_PATH%\bin\hipify-clang.exe

REM ---- Fix hipMemAddressReserve alignment for AMD Windows ----
REM Generate and run patch script via base64 to avoid CMD escaping issues
echo Patching source files for AMD Windows pre-reserved VA support...
python -c "import base64; open('_patch_prereserved.py','w').write(base64.b64decode('aW1wb3J0IHN5cywgcmUKCiMgLS0tIG1vZGVsLXZiYXIuYyAtLS0KdHJ5OgogICAgYyA9IG9wZW4oJ2hpcF9zcmMvbW9kZWwtdmJhci5jJykucmVhZCgpCmV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgIHByaW50KCcgIGhpcF9zcmMvbW9kZWwtdmJhci5jIG5vdCBmb3VuZCcsIGZpbGU9c3lzLnN0ZGVycikKICAgIHN5cy5leGl0KDEpCgppZiAndmJhcl9leHRlcm5hbGx5X3Jlc2VydmVkJyBpbiBjOgogICAgcHJpbnQoJyAgbW9kZWwtdmJhci5jIDogYWxyZWFkeSBwYXRjaGVkLicpCmVsc2U6CiAgICBjID0gYy5yZXBsYWNlKAogICAgICAgICcgICAgc2l6ZV90IHJlc2lkZW50X2NvdW50O1xuXG4gICAgUmVzaWRlbnRQYWdlIHJlc2lkZW5jeV9tYXBbMV07JywKICAgICAgICAnICAgIHNpemVfdCByZXNpZGVudF9jb3VudDtcbiAgICBpbnQgdmJhcl9leHRlcm5hbGx5X3Jlc2VydmVkO1xuXG4gICAgUmVzaWRlbnRQYWdlIHJlc2lkZW5jeV9tYXBbMV07JwogICAgKQogICAgYyA9IGMucmVwbGFjZSgKICAgICAgICAndm9pZCAqdmJhcl9hbGxvY2F0ZSh1aW50NjRfdCBzaXplLCBpbnQgZGV2aWNlKSB7JywKICAgICAgICAndm9pZCAqdmJhcl9hbGxvY2F0ZSh1aW50NjRfdCBzaXplLCBpbnQgZGV2aWNlLCB1aW50NjRfdCBwcmVfcmVzZXJ2ZWQpIHsnCiAgICApCiAgICBjID0gYy5yZXBsYWNlKAogICAgICAgICcgICAgbG9nKERFQlVHLCAiJXMgKHN0YXJ0KTogc2l6ZT0lenVNLCBkZXZpY2U9JWRcXG4iLCBfX2Z1bmNfXywgc2l6ZSAvIE0sIGRldmljZSk7JywKICAgICAgICAnICAgIGxvZyhERUJVRywgIiVzIChzdGFydCk6IHNpemU9JXp1TSwgZGV2aWNlPSVkIHByZT0lcFxcbiIsIF9fZnVuY19fLCBzaXplIC8gTSwgZGV2aWNlLCAodm9pZCopKHVpbnRwdHJfdClwcmVfcmVzZXJ2ZWQpOycKICAgICkKICAgIG9sZF9yZXNlcnZlID0gKAogICAgICAgICcgICAgLyogRklYTUU6IERvIEkgY2FyZSBhYm91dCBhbGlnbm1lbnQ/IERvZXMgQ3VkYSBqdXN0IGxvb2sgYWZ0ZXIgaXRzZWxmPyAqL1xuJwogICAgICAgICcgICAgaWYgKCFDSEVDS19DVShjdU1lbUFkZHJlc3NSZXNlcnZlKCZtdi0+dmJhciwgc2l6ZSwgMCwgMCwgMCkpKSB7XG4nCiAgICAgICAgJyAgICAgICAgbG9nKEVSUk9SLCAiQ291bGQgbm90IHJlc2V2ZSBWaXJ0dWFsIEFkZHJlc3Mgc3BhY2UgZm9yIFZCQVJcXG4iKTtcbicKICAgICAgICAnICAgICAgICBmcmVlKG12KTtcbicKICAgICAgICAnICAgICAgICByZXR1cm4gTlVMTDtcbicKICAgICAgICAnICAgIH0nCiAgICApCiAgICBuZXdfcmVzZXJ2ZSA9ICgKICAgICAgICAnICAgIGlmIChwcmVfcmVzZXJ2ZWQpIHtcbicKICAgICAgICAnICAgICAgICBtdi0+dmJhciA9IChDVWRldmljZXB0cikodWludHB0cl90KXByZV9yZXNlcnZlZDtcbicKICAgICAgICAnICAgICAgICBtdi0+dmJhcl9leHRlcm5hbGx5X3Jlc2VydmVkID0gMTtcbicKICAgICAgICAnICAgIH0gZWxzZSB7XG4nCiAgICAgICAgJyAgICAgICAgaWYgKCFDSEVDS19DVShjdU1lbUFkZHJlc3NSZXNlcnZlKCZtdi0+dmJhciwgc2l6ZSwgMCwgMCwgMCkpKSB7XG4nCiAgICAgICAgJyAgICAgICAgICAgIGxvZyhFUlJPUiwgIkNvdWxkIG5vdCByZXNldmUgVmlydHVhbCBBZGRyZXNzIHNwYWNlIGZvciBWQkFSXFxuIik7XG4nCiAgICAgICAgJyAgICAgICAgICAgIGZyZWUobXYpO1xuJwogICAgICAgICcgICAgICAgICAgICByZXR1cm4gTlVMTDtcbicKICAgICAgICAnICAgICAgICB9XG4nCiAgICAgICAgJyAgICAgICAgbXYtPnZiYXJfZXh0ZXJuYWxseV9yZXNlcnZlZCA9IDA7XG4nCiAgICAgICAgJyAgICB9JwogICAgKQogICAgaWYgb2xkX3Jlc2VydmUgbm90IGluIGM6CiAgICAgICAgcHJpbnQoJyAgV0FSTklORzogbW9kZWwtdmJhci5jIHJlc2VydmUgYmxvY2sgbm90IGZvdW5kJywgZmlsZT1zeXMuc3RkZXJyKQogICAgICAgIHN5cy5leGl0KDEpCiAgICBjID0gYy5yZXBsYWNlKG9sZF9yZXNlcnZlLCBuZXdfcmVzZXJ2ZSkKICAgIG9sZF9mcmVlMiA9ICgKICAgICAgICAnICAgIGZvciAodWludDY0X3QgcGFnZV9uciA9IDA7IHBhZ2VfbnIgPCBtdi0+bnJfcGFnZXM7IHBhZ2VfbnIrKykge1xuJwogICAgICAgICcgICAgICAgIG1vZDEobXYsIHBhZ2VfbnIsIHRydWUsIHRydWUpO1xuJwogICAgICAgICcgICAgfVxuJwogICAgICAgICcgICAgcmVtb3ZlX3ZiYXIobXYpO1xuJwogICAgICAgICcgICAgZnJlZShtdik7XG4nCiAgICAgICAgJ30nCiAgICApCiAgICBuZXdfZnJlZTIgPSAoCiAgICAgICAgJyAgICBmb3IgKHVpbnQ2NF90IHBhZ2VfbnIgPSAwOyBwYWdlX25yIDwgbXYtPm5yX3BhZ2VzOyBwYWdlX25yKyspIHtcbicKICAgICAgICAnICAgICAgICBtb2QxKG12LCBwYWdlX25yLCB0cnVlLCB0cnVlKTtcbicKICAgICAgICAnICAgIH1cbicKICAgICAgICAnICAgIHJlbW92ZV92YmFyKG12KTtcbicKICAgICAgICAnICAgIGlmICghbXYtPnZiYXJfZXh0ZXJuYWxseV9yZXNlcnZlZCkge1xuJwogICAgICAgICcgICAgICAgIENIRUNLX0NVKGN1TWVtQWRkcmVzc0ZyZWUobXYtPnZiYXIsIG12LT5ucl9wYWdlcyAqIFZCQVJfUEFHRV9TSVpFKSk7XG4nCiAgICAgICAgJyAgICB9XG4nCiAgICAgICAgJyAgICBmcmVlKG12KTtcbicKICAgICAgICAnfScKICAgICkKICAgIGlmIG9sZF9mcmVlMiBub3QgaW4gYzoKICAgICAgICBwcmludCgnICBXQVJOSU5HOiBtb2RlbC12YmFyLmMgdmJhcl9mcmVlIGJsb2NrIG5vdCBmb3VuZCcsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICBzeXMuZXhpdCgxKQogICAgYyA9IGMucmVwbGFjZShvbGRfZnJlZTIsIG5ld19mcmVlMikKICAgIG9wZW4oJ2hpcF9zcmMvbW9kZWwtdmJhci5jJywgJ3cnKS53cml0ZShjKQogICAgcHJpbnQoJyAgbW9kZWwtdmJhci5jIDogcGF0Y2hlZCBPSy4nKQoKIyAtLS0gdnJhbWJ1Zi5oIC0tLQp0cnk6CiAgICBoID0gb3BlbignaGlwX3NyYy92cmFtYnVmLmgnKS5yZWFkKCkKZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgcHJpbnQoJyAgaGlwX3NyYy92cmFtYnVmLmggbm90IGZvdW5kJywgZmlsZT1zeXMuc3RkZXJyKQogICAgc3lzLmV4aXQoMSkKCmlmICdleHRlcm5hbGx5X3Jlc2VydmVkJyBpbiBoOgogICAgcHJpbnQoJyAgdnJhbWJ1Zi5oIDogYWxyZWFkeSBwYXRjaGVkLicpCmVsc2U6CiAgICBoID0gaC5yZXBsYWNlKAogICAgICAgICcgICAgaW50IGRldmljZTtcbiAgICBzdHJ1Y3QgVnJhbUJ1ZmZlciAqbmV4dDsnLAogICAgICAgICcgICAgaW50IGRldmljZTtcbiAgICBpbnQgZXh0ZXJuYWxseV9yZXNlcnZlZDtcbiAgICBzdHJ1Y3QgVnJhbUJ1ZmZlciAqbmV4dDsnCiAgICApCiAgICBoID0gaC5yZXBsYWNlKAogICAgICAgICd2b2lkICp2cmFtYnVmX2NyZWF0ZShpbnQgZGV2aWNlLCBzaXplX3QgbWF4X3NpemUpOycsCiAgICAgICAgJ3ZvaWQgKnZyYW1idWZfY3JlYXRlKGludCBkZXZpY2UsIHNpemVfdCBtYXhfc2l6ZSwgdWludDY0X3QgcHJlX3Jlc2VydmVkKTsnCiAgICApCiAgICBvcGVuKCdoaXBfc3JjL3ZyYW1idWYuaCcsICd3Jykud3JpdGUoaCkKICAgIHByaW50KCcgIHZyYW1idWYuaCA6IHBhdGNoZWQgT0suJykKCiMgLS0tIHZyYW1idWYuYyAtLS0KdHJ5OgogICAgYyA9IG9wZW4oJ2hpcF9zcmMvdnJhbWJ1Zi5jJykucmVhZCgpCmV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgIHByaW50KCcgIGhpcF9zcmMvdnJhbWJ1Zi5jIG5vdCBmb3VuZCcsIGZpbGU9c3lzLnN0ZGVycikKICAgIHN5cy5leGl0KDEpCgppZiAnZXh0ZXJuYWxseV9yZXNlcnZlZCcgaW4gYzoKICAgIHByaW50KCcgIHZyYW1idWYuYyA6IGFscmVhZHkgcGF0Y2hlZC4nKQplbHNlOgogICAgYyA9IGMucmVwbGFjZSgKICAgICAgICAndm9pZCAqdnJhbWJ1Zl9jcmVhdGUoaW50IGRldmljZSwgc2l6ZV90IG1heF9zaXplKSB7JywKICAgICAgICAndm9pZCAqdnJhbWJ1Zl9jcmVhdGUoaW50IGRldmljZSwgc2l6ZV90IG1heF9zaXplLCB1aW50NjRfdCBwcmVfcmVzZXJ2ZWQpIHsnCiAgICApCiAgICBvbGRfcmVzID0gKAogICAgICAgICcgICAgYnVmLT5kZXZpY2UgPSBkZXZpY2U7XG4nCiAgICAgICAgJyAgICBidWYtPm1heF9zaXplID0gbWF4X3NpemU7XG4nCiAgICAgICAgJ1xuJwogICAgICAgICcgICAgaWYgKCFDSEVDS19DVShjdU1lbUFkZHJlc3NSZXNlcnZlKCZidWYtPmJhc2VfcHRyLCBtYXhfc2l6ZSwgMCwgMCwgMCkpKSB7XG4nCiAgICAgICAgJyAgICAgICAgZnJlZShidWYpO1xuJwogICAgICAgICcgICAgICAgIHJldHVybiBOVUxMO1xuJwogICAgICAgICcgICAgfScKICAgICkKICAgIG5ld19yZXMgPSAoCiAgICAgICAgJyAgICBidWYtPmRldmljZSA9IGRldmljZTtcbicKICAgICAgICAnICAgIGJ1Zi0+bWF4X3NpemUgPSBtYXhfc2l6ZTtcbicKICAgICAgICAnICAgIGJ1Zi0+ZXh0ZXJuYWxseV9yZXNlcnZlZCA9IChwcmVfcmVzZXJ2ZWQgIT0gMCk7XG4nCiAgICAgICAgJ1xuJwogICAgICAgICcgICAgaWYgKHByZV9yZXNlcnZlZCkge1xuJwogICAgICAgICcgICAgICAgIGJ1Zi0+YmFzZV9wdHIgPSAoQ1VkZXZpY2VwdHIpKHVpbnRwdHJfdClwcmVfcmVzZXJ2ZWQ7XG4nCiAgICAgICAgJyAgICB9IGVsc2Uge1xuJwogICAgICAgICcgICAgICAgIGlmICghQ0hFQ0tfQ1UoY3VNZW1BZGRyZXNzUmVzZXJ2ZSgmYnVmLT5iYXNlX3B0ciwgbWF4X3NpemUsIDAsIDAsIDApKSkge1xuJwogICAgICAgICcgICAgICAgICAgICBmcmVlKGJ1Zik7XG4nCiAgICAgICAgJyAgICAgICAgICAgIHJldHVybiBOVUxMO1xuJwogICAgICAgICcgICAgICAgIH1cbicKICAgICAgICAnICAgIH0nCiAgICApCiAgICBpZiBvbGRfcmVzIG5vdCBpbiBjOgogICAgICAgIHByaW50KCcgIFdBUk5JTkc6IHZyYW1idWYuYyByZXNlcnZlIGJsb2NrIG5vdCBmb3VuZCcsIGZpbGU9c3lzLnN0ZGVycikKICAgICAgICBzeXMuZXhpdCgxKQogICAgYyA9IGMucmVwbGFjZShvbGRfcmVzLCBuZXdfcmVzKQogICAgYyA9IGMucmVwbGFjZSgKICAgICAgICAnICAgIENIRUNLX0NVKGN1TWVtQWRkcmVzc0ZyZWUoYnVmLT5iYXNlX3B0ciwgYnVmLT5tYXhfc2l6ZSkpO1xuICAgIHRvdGFsX3ZyYW1fdXNhZ2UnLAogICAgICAgICcgICAgaWYgKCFidWYtPmV4dGVybmFsbHlfcmVzZXJ2ZWQpIHtcbiAgICAgICAgQ0hFQ0tfQ1UoY3VNZW1BZGRyZXNzRnJlZShidWYtPmJhc2VfcHRyLCBidWYtPm1heF9zaXplKSk7XG4gICAgfVxuICAgIHRvdGFsX3ZyYW1fdXNhZ2UnCiAgICApCiAgICBvcGVuKCdoaXBfc3JjL3ZyYW1idWYuYycsICd3Jykud3JpdGUoYykKICAgIHByaW50KCcgIHZyYW1idWYuYyA6IHBhdGNoZWQgT0suJykKCiMgLS0tIHB5dC1jdS1wbHVnLWFsbG9jLmMgLS0tCnRyeToKICAgIGMgPSBvcGVuKCdoaXBfc3JjL3B5dC1jdS1wbHVnLWFsbG9jLmMnKS5yZWFkKCkKZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgcHJpbnQoJyAgaGlwX3NyYy9weXQtY3UtcGx1Zy1hbGxvYy5jIG5vdCBmb3VuZCcsIGZpbGU9c3lzLnN0ZGVycikKICAgIHN5cy5leGl0KDEpCgppZiAndnJhbWJ1Zl9jcmVhdGUoZGV2aWNlLCB2aXJ0X3NpemUsIDApJyBpbiBjOgogICAgcHJpbnQoJyAgcHl0LWN1LXBsdWctYWxsb2MuYyA6IGFscmVhZHkgcGF0Y2hlZC4nKQplbHNlOgogICAgYyA9IGMucmVwbGFjZSgndnJhbWJ1Zl9jcmVhdGUoZGV2aWNlLCB2aXJ0X3NpemUpJywgJ3ZyYW1idWZfY3JlYXRlKGRldmljZSwgdmlydF9zaXplLCAwKScpCiAgICBvcGVuKCdoaXBfc3JjL3B5dC1jdS1wbHVnLWFsbG9jLmMnLCAndycpLndyaXRlKGMpCiAgICBwcmludCgnICBweXQtY3UtcGx1Zy1hbGxvYy5jIDogcGF0Y2hlZCBPSy4nKQoKIyAtLS0gcGxhdC5oIDogZnVsbCBDVURBLT5ISVAgdHJhbnNsYXRpb24gKGJ5cGFzc2VzIFBvd2VyU2hlbGwgU2V0LUNvbnRlbnQgZW5jb2RpbmcgaXNzdWVzKSAtLS0KaW1wb3J0IHJlIGFzIF9yZQoKdHJ5OgogICAgaCA9IG9wZW4oJ2hpcF9zcmMvcGxhdC5oJykucmVhZCgpCmV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgIHByaW50KCcgIGhpcF9zcmMvcGxhdC5oIG5vdCBmb3VuZCcsIGZpbGU9c3lzLnN0ZGVycikKICAgIHN5cy5leGl0KDEpCgppZiAnI2luY2x1ZGUgPGhpcC9oaXBfcnVudGltZS5oPicgaW4gaDoKICAgIHByaW50KCcgIHBsYXQuaCA6IGFscmVhZHkgcGF0Y2hlZC4nKQplbHNlOgogICAgIyBJbmNsdWRlCiAgICBoID0gaC5yZXBsYWNlKCcjaW5jbHVkZSA8Y3VkYS5oPicsICcjaW5jbHVkZSA8aGlwL2hpcF9ydW50aW1lLmg+JykKICAgIGggPSBoLnJlcGxhY2UoJyNpbmNsdWRlIDxjdWRhX3J1bnRpbWUuaD4nLCAnI2luY2x1ZGUgPGhpcC9oaXBfcnVudGltZS5oPicpCiAgICAjIFR5cGVzICh3aG9sZS13b3JkIHJlcGxhY2VtZW50cyB1c2luZyByZS5zdWIpCiAgICBkZWYgd2Iob2xkLCBuZXcsIHMpOgogICAgICAgIHJldHVybiBfcmUuc3ViKHInXGInICsgX3JlLmVzY2FwZShvbGQpICsgcidcYicsIG5ldywgcykKICAgIGggPSB3YignQ1VkZXZpY2UnLCAnaGlwRGV2aWNlX3QnLCBoKQogICAgaCA9IHdiKCdDVWRldmljZXB0cicsICdoaXBEZXZpY2VwdHJfdCcsIGgpCiAgICBoID0gd2IoJ0NVcmVzdWx0JywgJ2hpcEVycm9yX3QnLCBoKQogICAgaCA9IHdiKCdDVW1lbUdlbmVyaWNBbGxvY2F0aW9uSGFuZGxlJywgJ2hpcE1lbUdlbmVyaWNBbGxvY2F0aW9uSGFuZGxlX3QnLCBoKQogICAgaCA9IHdiKCdDVW1lbUFsbG9jYXRpb25Qcm9wJywgJ2hpcE1lbUFsbG9jYXRpb25Qcm9wJywgaCkKICAgIGggPSB3YignQ1VtZW1BY2Nlc3NEZXNjJywgJ2hpcE1lbUFjY2Vzc0Rlc2MnLCBoKQogICAgaCA9IHdiKCdDVXN0cmVhbScsICdoaXBTdHJlYW1fdCcsIGgpCiAgICAjIENvbnN0YW50cwogICAgaCA9IHdiKCdDVURBX1NVQ0NFU1MnLCAnaGlwU3VjY2VzcycsIGgpCiAgICBoID0gd2IoJ0NVREFfRVJST1JfT1VUX09GX01FTU9SWScsICdoaXBFcnJvck91dE9mTWVtb3J5JywgaCkKICAgIGggPSB3YignQ1VfTUVNX0FMTE9DQVRJT05fVFlQRV9QSU5ORUQnLCAnaGlwTWVtQWxsb2NhdGlvblR5cGVQaW5uZWQnLCBoKQogICAgaCA9IHdiKCdDVV9NRU1fTE9DQVRJT05fVFlQRV9ERVZJQ0UnLCAnaGlwTWVtTG9jYXRpb25UeXBlRGV2aWNlJywgaCkKICAgIGggPSB3YignQ1VfTUVNX0FDQ0VTU19GTEFHU19QUk9UX1JFQURXUklURScsICdoaXBNZW1BY2Nlc3NGbGFnc1Byb3RSZWFkV3JpdGUnLCBoKQogICAgIyBGdW5jdGlvbnMKICAgICMgY3VHZXRFcnJvclN0cmluZyhyZXMsICZkZXNjKSAtPiAoKGRlc2MgPSBoaXBHZXRFcnJvclN0cmluZyhyZXMpKSA9PSBOVUxMID8gaGlwRXJyb3JVbmtub3duIDogaGlwU3VjY2VzcykKICAgIGggPSBfcmUuc3ViKAogICAgICAgIHInY3VHZXRFcnJvclN0cmluZ1woKFteLF0rKSxccyomKFx3KylccypcKScsCiAgICAgICAgcicoKFwyID0gaGlwR2V0RXJyb3JTdHJpbmcoXDEpKSA9PSBOVUxMID8gaGlwRXJyb3JVbmtub3duIDogaGlwU3VjY2VzcyknLAogICAgICAgIGgKICAgICkKICAgIGggPSB3YignY3VHZXRFcnJvclN0cmluZycsICdoaXBHZXRFcnJvclN0cmluZycsIGgpCiAgICBoID0gd2IoJ2N1TWVtQ3JlYXRlJywgJ2hpcE1lbUNyZWF0ZScsIGgpCiAgICBoID0gd2IoJ2N1TWVtU2V0QWNjZXNzJywgJ2hpcE1lbVNldEFjY2VzcycsIGgpCiAgICBoID0gd2IoJ2N1TWVtTWFwJywgJ2hpcE1lbU1hcCcsIGgpCiAgICBoID0gd2IoJ2N1TWVtVW5tYXAnLCAnaGlwTWVtVW5tYXAnLCBoKQogICAgaCA9IHdiKCdjdU1lbVJlbGVhc2UnLCAnaGlwTWVtUmVsZWFzZScsIGgpCiAgICBoID0gd2IoJ2N1TWVtQWRkcmVzc1Jlc2VydmUnLCAnaGlwTWVtQWRkcmVzc1Jlc2VydmUnLCBoKQogICAgaCA9IHdiKCdjdU1lbUFkZHJlc3NGcmVlJywgJ2hpcE1lbUFkZHJlc3NGcmVlJywgaCkKICAgIGggPSB3YignY3VEZXZpY2VHZXQnLCAnaGlwRGV2aWNlR2V0JywgaCkKICAgIGggPSB3YignY3VEZXZpY2VUb3RhbE1lbScsICdoaXBEZXZpY2VUb3RhbE1lbScsIGgpCiAgICBoID0gd2IoJ2N1RGV2aWNlR2V0TmFtZScsICdoaXBEZXZpY2VHZXROYW1lJywgaCkKICAgIGggPSB3YignY3VNZW1HZXRJbmZvJywgJ2hpcE1lbUdldEluZm8nLCBoKQogICAgaCA9IHdiKCdjdUN0eFN5bmNocm9uaXplJywgJ2hpcERldmljZVN5bmNocm9uaXplJywgaCkKICAgIGggPSB3YignY3VDdHhHZXREZXZpY2UnLCAnaGlwR2V0RGV2aWNlJywgaCkKICAgIGggPSBoLnJlcGxhY2UoJ2hpcEdldERldmljZSgmJywgJ2hpcEdldERldmljZSgoaW50KikmJykKICAgIGggPSB3YignY3VNZW1BbGxvY0FzeW5jJywgJ2hpcE1hbGxvY0FzeW5jJywgaCkKICAgIGggPSB3YignY3VNZW1GcmVlQXN5bmMnLCAnaGlwRnJlZUFzeW5jJywgaCkKICAgICMgY3VHZXRFcnJvclN0cmluZyBjYWxsLXNpdGUgdHJhbnNmb3JtOiBjdUdldEVycm9yU3RyaW5nKHJlcywgJmRlc2MpIC0+IGhpcEdldEVycm9yU3RyaW5nKHJlcykKICAgICMgKGFscmVhZHkgcmVuYW1lZCBhYm92ZTsgdGhlIHNlY29uZCBhcmcgJmRlc2MgYXNzaWdubWVudCBuZWVkcyBzcGVjaWFsIGhhbmRsaW5nIGluIHRoZSBzb3VyY2UpCiAgICAjIFJlbW92ZSBkdXBsaWNhdGUgdHlwZWRlZiBpZiBoaXBpZnkgYWxyZWFkeSByYW4gKHNhZmV0eSkKICAgIGggPSBoLnJlcGxhY2UoJ3R5cGVkZWYgc3RydWN0IENVc3RyZWFtX3N0ICpoaXBTdHJlYW1fdDtcbicsICcnKQogICAgb3BlbignaGlwX3NyYy9wbGF0LmgnLCAndycsIGVuY29kaW5nPSd1dGYtOCcpLndyaXRlKGgpCiAgICBwcmludCgnICBwbGF0LmggOiBwYXRjaGVkIE9LLicpCg==').decode())"
python _patch_prereserved.py
if %errorlevel% neq 0 (
    echo ERROR: Pre-reserved VA patch failed.
    goto :fail
)
del /F /Q _patch_prereserved.py
REM ---- HIPify ----
echo Converting CUDA to HIP...
if not exist "%HIPIFY_EXE%" (
    echo WARNING: hipify-clang not found at %HIPIFY_EXE%, trying PATH...
    set HIPIFY_EXE=hipify-clang
)
for %%f in (hip_src\*.h hip_src\*.c) do (
    "%HIPIFY_EXE%" --default-preprocessor --clang-resource-directory="%CLANG_RESOURCE_DIR%" --cuda-path=%CUDA_LINK% --cuda-gpu-arch=sm_52 --inplace "%%f" >nul 2>nul
)

REM ---- Manual type replacements (hipify misses some) ----
echo Applying type replacements...
powershell -EncodedCommand JABmAGkAbABlAHMAIAA9ACAAQAAoAEcAZQB0AC0AQwBoAGkAbABkAEkAdABlAG0AIABoAGkAcABfAHMAcgBjAFwAKgAuAGgAIAB8ACAARgBvAHIARQBhAGMAaAAtAE8AYgBqAGUAYwB0ACAAewAgACQAXwAuAEYAdQBsAGwATgBhAG0AZQAgAH0AKQAgACsAIABAACgARwBlAHQALQBDAGgAaQBsAGQASQB0AGUAbQAgAGgAaQBwAF8AcwByAGMAXAAqAC4AYwAgAHwAIABGAG8AcgBFAGEAYwBoAC0ATwBiAGoAZQBjAHQAIAB7ACAAJABfAC4ARgB1AGwAbABOAGEAbQBlACAAfQApAAoAZgBvAHIAZQBhAGMAaAAgACgAJABmAGkAbABlACAAaQBuACAAJABmAGkAbABlAHMAKQAgAHsACgAgACAAIAAgAGkAZgAgACgALQBuAG8AdAAgACgAVABlAHMAdAAtAFAAYQB0AGgAIAAkAGYAaQBsAGUAKQApACAAewAgAGMAbwBuAHQAaQBuAHUAZQAgAH0ACgAgACAAIAAgACQAYwBvAG4AdABlAG4AdAAgAD0AIABHAGUAdAAtAEMAbwBuAHQAZQBuAHQAIAAkAGYAaQBsAGUAIAAtAFIAYQB3AAoAIAAgACAAIAAkAGMAbwBuAHQAZQBuAHQAIAA9ACAAJABjAG8AbgB0AGUAbgB0ACAALQByAGUAcABsAGEAYwBlACAAJwAjAGkAbgBjAGwAdQBkAGUAIAA8AGMAdQBkAGEAXAAuAGgAPgAnACwAIAAnACMAaQBuAGMAbAB1AGQAZQAgADwAaABpAHAALwBoAGkAcABfAHIAdQBuAHQAaQBtAGUALgBoAD4AJwAKACAAIAAgACAAJABjAG8AbgB0AGUAbgB0ACAAPQAgACQAYwBvAG4AdABlAG4AdAAgAC0AcgBlAHAAbABhAGMAZQAgACcAIwBpAG4AYwBsAHUAZABlACAAPABjAHUAZABhAF8AcgB1AG4AdABpAG0AZQBcAC4AaAA+ACcALAAgACcAIwBpAG4AYwBsAHUAZABlACAAPABoAGkAcAAvAGgAaQBwAF8AcgB1AG4AdABpAG0AZQAuAGgAPgAnAAoAIAAgACAAIAAkAGMAbwBuAHQAZQBuAHQAIAA9ACAAJABjAG8AbgB0AGUAbgB0ACAALQByAGUAcABsAGEAYwBlACAAJwBcAGIAQwBVAGQAZQB2AGkAYwBlAFwAYgAnACwAIAAnAGgAaQBwAEQAZQB2AGkAYwBlAF8AdAAnAAoAIAAgACAAIAAkAGMAbwBuAHQAZQBuAHQAIAA9ACAAJABjAG8AbgB0AGUAbgB0ACAALQByAGUAcABsAGEAYwBlACAAJwBcAGIAQwBVAGQAZQB2AGkAYwBlAHAAdAByAFwAYgAnACwAIAAnAGgAaQBwAEQAZQB2AGkAYwBlAHAAdAByAF8AdAAnAAoAIAAgACAAIAAkAGMAbwBuAHQAZQBuAHQAIAA9ACAAJABjAG8AbgB0AGUAbgB0ACAALQByAGUAcABsAGEAYwBlACAAJwBcAGIAQwBVAHIAZQBzAHUAbAB0AFwAYgAnACwAIAAnAGgAaQBwAEUAcgByAG8AcgBfAHQAJwAKACAAIAAgACAAJABjAG8AbgB0AGUAbgB0ACAAPQAgACQAYwBvAG4AdABlAG4AdAAgAC0AcgBlAHAAbABhAGMAZQAgACcAXABiAEMAVQBEAEEAXwBTAFUAQwBDAEUAUwBTAFwAYgAnACwAIAAnAGgAaQBwAFMAdQBjAGMAZQBzAHMAJwAKACAAIAAgACAAJABjAG8AbgB0AGUAbgB0ACAAPQAgACQAYwBvAG4AdABlAG4AdAAgAC0AcgBlAHAAbABhAGMAZQAgACcAXABiAEMAVQBEAEEAXwBFAFIAUgBPAFIAXwBPAFUAVABfAE8ARgBfAE0ARQBNAE8AUgBZAFwAYgAnACwAIAAnAGgAaQBwAEUAcgByAG8AcgBPAHUAdABPAGYATQBlAG0AbwByAHkAJwAKACAAIAAgACAAJABjAG8AbgB0AGUAbgB0ACAAPQAgACQAYwBvAG4AdABlAG4AdAAgAC0AcgBlAHAAbABhAGMAZQAgACcAXABiAEMAVQBtAGUAbQBHAGUAbgBlAHIAaQBjAEEAbABsAG8AYwBhAHQAaQBvAG4ASABhAG4AZABsAGUAXABiACcALAAgACcAaABpAHAATQBlAG0ARwBlAG4AZQByAGkAYwBBAGwAbABvAGMAYQB0AGkAbwBuAEgAYQBuAGQAbABlAF8AdAAnAAoAIAAgACAAIAAkAGMAbwBuAHQAZQBuAHQAIAA9ACAAJABjAG8AbgB0AGUAbgB0ACAALQByAGUAcABsAGEAYwBlACAAJwBcAGIAYwB1AGQAYQBTAHQAcgBlAGEAbQBfAHQAXABiACcALAAgACcAaABpAHAAUwB0AHIAZQBhAG0AXwB0ACcACgAgACAAIAAgACQAYwBvAG4AdABlAG4AdAAgAD0AIAAkAGMAbwBuAHQAZQBuAHQAIAAtAHIAZQBwAGwAYQBjAGUAIAAnAFwAYgBjAHUATQBlAG0ARwBlAHQASQBuAGYAbwBcAGIAJwAsACAAJwBoAGkAcABNAGUAbQBHAGUAdABJAG4AZgBvACcACgAgACAAIAAgACQAYwBvAG4AdABlAG4AdAAgAD0AIAAkAGMAbwBuAHQAZQBuAHQAIAAtAHIAZQBwAGwAYQBjAGUAIAAnAFwAYgBjAHUARABlAHYAaQBjAGUARwBlAHQAXABiACcALAAgACcAaABpAHAARABlAHYAaQBjAGUARwBlAHQAJwAKACAAIAAgACAAJABjAG8AbgB0AGUAbgB0ACAAPQAgACQAYwBvAG4AdABlAG4AdAAgAC0AcgBlAHAAbABhAGMAZQAgACcAXABiAGMAdQBEAGUAdgBpAGMAZQBUAG8AdABhAGwATQBlAG0AXABiACcALAAgACcAaABpAHAARABlAHYAaQBjAGUAVABvAHQAYQBsAE0AZQBtACcACgAgACAAIAAgACQAYwBvAG4AdABlAG4AdAAgAD0AIAAkAGMAbwBuAHQAZQBuAHQAIAAtAHIAZQBwAGwAYQBjAGUAIAAnAFwAYgBjAHUARABlAHYAaQBjAGUARwBlAHQATgBhAG0AZQBcAGIAJwAsACAAJwBoAGkAcABEAGUAdgBpAGMAZQBHAGUAdABOAGEAbQBlACcACgAgACAAIAAgACQAYwBvAG4AdABlAG4AdAAgAD0AIAAkAGMAbwBuAHQAZQBuAHQAIAAtAHIAZQBwAGwAYQBjAGUAIAAnAFwAYgBjAHUATQBlAG0AVQBuAG0AYQBwAFwAYgAnACwAIAAnAGgAaQBwAE0AZQBtAFUAbgBtAGEAcAAnAAoAIAAgACAAIAAkAGMAbwBuAHQAZQBuAHQAIAA9ACAAJABjAG8AbgB0AGUAbgB0ACAALQByAGUAcABsAGEAYwBlACAAJwBcAGIAYwB1AE0AZQBtAFIAZQBsAGUAYQBzAGUAXABiACcALAAgACcAaABpAHAATQBlAG0AUgBlAGwAZQBhAHMAZQAnAAoAIAAgACAAIAAkAGMAbwBuAHQAZQBuAHQAIAA9ACAAJABjAG8AbgB0AGUAbgB0ACAALQByAGUAcABsAGEAYwBlACAAJwBcAGIAYwB1AE0AZQBtAEEAZABkAHIAZQBzAHMAUgBlAHMAZQByAHYAZQBcAGIAJwAsACAAJwBoAGkAcABNAGUAbQBBAGQAZAByAGUAcwBzAFIAZQBzAGUAcgB2AGUAJwAKACAAIAAgACAAJABjAG8AbgB0AGUAbgB0ACAAPQAgACQAYwBvAG4AdABlAG4AdAAgAC0AcgBlAHAAbABhAGMAZQAgACcAXABiAGMAdQBNAGUAbQBBAGQAZAByAGUAcwBzAEYAcgBlAGUAXABiACcALAAgACcAaABpAHAATQBlAG0AQQBkAGQAcgBlAHMAcwBGAHIAZQBlACcACgAgACAAIAAgACQAYwBvAG4AdABlAG4AdAAgAD0AIAAkAGMAbwBuAHQAZQBuAHQAIAAtAHIAZQBwAGwAYQBjAGUAIAAnAFwAYgBjAHUATQBlAG0AQwByAGUAYQB0AGUAXABiACcALAAgACcAaABpAHAATQBlAG0AQwByAGUAYQB0AGUAJwAKACAAIAAgACAAJABjAG8AbgB0AGUAbgB0ACAAPQAgACQAYwBvAG4AdABlAG4AdAAgAC0AcgBlAHAAbABhAGMAZQAgACcAXABiAGMAdQBNAGUAbQBTAGUAdABBAGMAYwBlAHMAcwBcAGIAJwAsACAAJwBoAGkAcABNAGUAbQBTAGUAdABBAGMAYwBlAHMAcwAnAAoAIAAgACAAIAAkAGMAbwBuAHQAZQBuAHQAIAA9ACAAJABjAG8AbgB0AGUAbgB0ACAALQByAGUAcABsAGEAYwBlACAAJwBcAGIAYwB1AE0AZQBtAE0AYQBwAFwAYgAnACwAIAAnAGgAaQBwAE0AZQBtAE0AYQBwACcACgAgACAAIAAgACQAYwBvAG4AdABlAG4AdAAgAD0AIAAkAGMAbwBuAHQAZQBuAHQAIAAtAHIAZQBwAGwAYQBjAGUAIAAnAFwAYgBjAHUAQwB0AHgAUwB5AG4AYwBoAHIAbwBuAGkAegBlAFwAYgAnACwAIAAnAGgAaQBwAEQAZQB2AGkAYwBlAFMAeQBuAGMAaAByAG8AbgBpAHoAZQAnAAoAIAAgACAAIAAkAGMAbwBuAHQAZQBuAHQAIAA9ACAAJABjAG8AbgB0AGUAbgB0ACAALQByAGUAcABsAGEAYwBlACAAJwBcAGIAYwB1AEMAdAB4AEcAZQB0AEQAZQB2AGkAYwBlAFwAYgAnACwAIAAnAGgAaQBwAEcAZQB0AEQAZQB2AGkAYwBlACcACgAgACAAIAAgACQAYwBvAG4AdABlAG4AdAAgAD0AIAAkAGMAbwBuAHQAZQBuAHQAIAAtAHIAZQBwAGwAYQBjAGUAIAAnAFwAYgBoAGkAcABDAHQAeABHAGUAdABEAGUAdgBpAGMAZQBcAGIAJwAsACAAJwBoAGkAcABHAGUAdABEAGUAdgBpAGMAZQAnAAoAIAAgACAAIAAkAGMAbwBuAHQAZQBuAHQAIAA9ACAAJABjAG8AbgB0AGUAbgB0ACAALQByAGUAcABsAGEAYwBlACAAJwBcAGIAaABpAHAARwBlAHQARABlAHYAaQBjAGUAXAAoACYAJwAsACAAJwBoAGkAcABHAGUAdABEAGUAdgBpAGMAZQAoACgAaQBuAHQAKgApACYAJwAKACAAIAAgACAAJABjAG8AbgB0AGUAbgB0ACAAPQAgACQAYwBvAG4AdABlAG4AdAAgAC0AcgBlAHAAbABhAGMAZQAgACcAXABiAGMAdQBNAGUAbQBBAGwAbABvAGMAQQBzAHkAbgBjAFwAYgAnACwAIAAnAGgAaQBwAE0AYQBsAGwAbwBjAEEAcwB5AG4AYwAnAAoAIAAgACAAIAAkAGMAbwBuAHQAZQBuAHQAIAA9ACAAJABjAG8AbgB0AGUAbgB0ACAALQByAGUAcABsAGEAYwBlACAAJwBcAGIAYwB1AE0AZQBtAEYAcgBlAGUAQQBzAHkAbgBjAFwAYgAnACwAIAAnAGgAaQBwAEYAcgBlAGUAQQBzAHkAbgBjACcACgAgACAAIAAgACQAYwBvAG4AdABlAG4AdAAgAD0AIAAkAGMAbwBuAHQAZQBuAHQAIAAtAHIAZQBwAGwAYQBjAGUAIAAnAFwAYgBDAFUAcwB0AHIAZQBhAG0AXABiACcALAAgACcAaABpAHAAUwB0AHIAZQBhAG0AXwB0ACcACgAgACAAIAAgACQAYwBvAG4AdABlAG4AdAAgAD0AIAAkAGMAbwBuAHQAZQBuAHQAIAAtAHIAZQBwAGwAYQBjAGUAIAAnAHQAeQBwAGUAZABlAGYAIABzAHQAcgB1AGMAdAAgAEMAVQBzAHQAcgBlAGEAbQBfAHMAdAAgAFwAKgBoAGkAcABTAHQAcgBlAGEAbQBfAHQAOwBcAHIAPwBcAG4AJwAsACAAJwAnAAoAIAAgACAAIAAkAGMAbwBuAHQAZQBuAHQAIAA9ACAAJABjAG8AbgB0AGUAbgB0ACAALQByAGUAcABsAGEAYwBlACAAJwBcAGIAYwB1AEcAZQB0AEUAcgByAG8AcgBTAHQAcgBpAG4AZwBcAHMAKgBcACgAKABbAF4ALABdACsAKQAsAFwAcwAqACYAKABcAHcAKwApAFwAcwAqAFwAKQAnACwAIAAnACgAKAAkADIAIAA9ACAAaABpAHAARwBlAHQARQByAHIAbwByAFMAdAByAGkAbgBnACgAJAAxACkAKQAgAD0APQAgAE4AVQBMAEwAIAA/ACAAaABpAHAARQByAHIAbwByAFUAbgBrAG4AbwB3AG4AIAA6ACAAaABpAHAAUwB1AGMAYwBlAHMAcwApACcACgAgACAAIAAgACQAYwBvAG4AdABlAG4AdAAgAD0AIAAkAGMAbwBuAHQAZQBuAHQAIAAtAHIAZQBwAGwAYQBjAGUAIAAnAFwAYgBjAHUARwBlAHQARQByAHIAbwByAFMAdAByAGkAbgBnAFwAYgAnACwAIAAnAGgAaQBwAEcAZQB0AEUAcgByAG8AcgBTAHQAcgBpAG4AZwAnAAoAIAAgACAAIAAkAGMAbwBuAHQAZQBuAHQAIAA9ACAAJABjAG8AbgB0AGUAbgB0ACAALQByAGUAcABsAGEAYwBlACAAJwBcAGIAQwBVAG0AZQBtAEEAbABsAG8AYwBhAHQAaQBvAG4AUAByAG8AcABcAGIAJwAsACAAJwBoAGkAcABNAGUAbQBBAGwAbABvAGMAYQB0AGkAbwBuAFAAcgBvAHAAJwAKACAAIAAgACAAJABjAG8AbgB0AGUAbgB0ACAAPQAgACQAYwBvAG4AdABlAG4AdAAgAC0AcgBlAHAAbABhAGMAZQAgACcAXABiAEMAVQBtAGUAbQBBAGMAYwBlAHMAcwBEAGUAcwBjAFwAYgAnACwAIAAnAGgAaQBwAE0AZQBtAEEAYwBjAGUAcwBzAEQAZQBzAGMAJwAKACAAIAAgACAAJABjAG8AbgB0AGUAbgB0ACAAPQAgACQAYwBvAG4AdABlAG4AdAAgAC0AcgBlAHAAbABhAGMAZQAgACcAXABiAEMAVQBfAE0ARQBNAF8AQQBMAEwATwBDAEEAVABJAE8ATgBfAFQAWQBQAEUAXwBQAEkATgBOAEUARABcAGIAJwAsACAAJwBoAGkAcABNAGUAbQBBAGwAbABvAGMAYQB0AGkAbwBuAFQAeQBwAGUAUABpAG4AbgBlAGQAJwAKACAAIAAgACAAJABjAG8AbgB0AGUAbgB0ACAAPQAgACQAYwBvAG4AdABlAG4AdAAgAC0AcgBlAHAAbABhAGMAZQAgACcAXABiAEMAVQBfAE0ARQBNAF8ATABPAEMAQQBUAEkATwBOAF8AVABZAFAARQBfAEQARQBWAEkAQwBFAFwAYgAnACwAIAAnAGgAaQBwAE0AZQBtAEwAbwBjAGEAdABpAG8AbgBUAHkAcABlAEQAZQB2AGkAYwBlACcACgAgACAAIAAgACQAYwBvAG4AdABlAG4AdAAgAD0AIAAkAGMAbwBuAHQAZQBuAHQAIAAtAHIAZQBwAGwAYQBjAGUAIAAnAFwAYgBDAFUAXwBNAEUATQBfAEEAQwBDAEUAUwBTAF8ARgBMAEEARwBTAF8AUABSAE8AVABfAFIARQBBAEQAVwBSAEkAVABFAFwAYgAnACwAIAAnAGgAaQBwAE0AZQBtAEEAYwBjAGUAcwBzAEYAbABhAGcAcwBQAHIAbwB0AFIAZQBhAGQAVwByAGkAdABlACcACgAgACAAIAAgAGkAZgAgACgAJABmAGkAbABlACAALQBuAG8AdABsAGkAawBlACAAJwAqAHMAaABtAGUAbQAtAGQAZQB0AGUAYwB0AC4AYwAnACAALQBhAG4AZAAgACQAZgBpAGwAZQAgAC0AbgBvAHQAbABpAGsAZQAgACcAKgBwAGwAYQB0AC4AaAAnACkAIAB7AAoAIAAgACAAIAAgACAAIAAgACQAYwBvAG4AdABlAG4AdAAgAD0AIAAkAGMAbwBuAHQAZQBuAHQAIAAtAHIAZQBwAGwAYQBjAGUAIAAnAFwAYgB3AGQAZABtAF8AYgB1AGQAZwBlAHQAXwBkAGUAZgBpAGMAaQB0AFwAYgAnACwAIAAnAGMAdQBkAGEAXwBiAHUAZABnAGUAdABfAGQAZQBmAGkAYwBpAHQAJwAKACAAIAAgACAAfQAKACAAIAAgACAAUwBlAHQALQBDAG8AbgB0AGUAbgB0ACAAJABmAGkAbABlACAAJABjAG8AbgB0AGUAbgB0AAoAfQAKAA==

REM ---- Generate AMD DXGI-based cuDeviceGetLuid implementation ----
echo Generating ROCm platform stubs...
if exist hip_src\rocm_stubs.c del /F /Q hip_src\rocm_stubs.c
(
echo #include ^<hip/hip_runtime.h^>
echo #include ^<windows.h^>
echo #include ^<dxgi1_4.h^>
echo #include ^<string.h^>
echo.
echo hipError_t cuDeviceGetLuid^(char *luid, unsigned int *deviceNodeMask, hipDevice_t dev^) {
echo     HRESULT hr;
echo     IDXGIFactory1 *factory = NULL;
echo     IDXGIAdapter1 *adapter = NULL;
echo     DXGI_ADAPTER_DESC1 desc;
echo.
echo     hr = CreateDXGIFactory1^(^&IID_IDXGIFactory1, ^(void**^)^&factory^);
echo     if ^(FAILED^(hr^)^) return hipErrorNotSupported;
echo.
echo     UINT adapterIndex = 0;
echo     while ^(factory-^>lpVtbl-^>EnumAdapters1^(factory, adapterIndex, ^&adapter^) == S_OK^) {
echo         hr = adapter-^>lpVtbl-^>GetDesc1^(adapter, ^&desc^);
echo         if ^(SUCCEEDED^(hr^) ^&^& desc.VendorId == 0x1002^) {
echo             if ^(luid^) memcpy^(luid, ^&desc.AdapterLuid, sizeof^(LUID^)^);
echo             if ^(deviceNodeMask^) *deviceNodeMask = 1;
echo             adapter-^>lpVtbl-^>Release^(adapter^);
echo             factory-^>lpVtbl-^>Release^(factory^);
echo             return hipSuccess;
echo         }
echo         if ^(adapter^) { adapter-^>lpVtbl-^>Release^(adapter^); adapter = NULL; }
echo         adapterIndex++;
echo     }
echo     if ^(factory^) factory-^>lpVtbl-^>Release^(factory^);
echo     return hipErrorNotSupported;
echo }
echo.
echo #include ^<stdbool.h^>
echo #include ^<stddef.h^>
echo.
echo /* cuda-detour.c stubs for ROCm - no CUDA hook detours needed */
echo bool aimdo_setup_hooks^(^) {
echo     return true;
echo }
echo void aimdo_teardown_hooks^(^) {}
) > hip_src\rocm_stubs.c

powershell -EncodedCommand JABmAGkAbABlACAAPQAgACcAaABpAHAAXwBzAHIAYwBcAHAAbABhAHQALgBoACcACgAkAGMAbwBuAHQAZQBuAHQAIAA9ACAARwBlAHQALQBDAG8AbgB0AGUAbgB0ACAAJABmAGkAbABlACAALQBSAGEAdwAKAGkAZgAgACgAJABjAG8AbgB0AGUAbgB0ACAALQBuAG8AdABtAGEAdABjAGgAIAAnAGgAaQBwAEUAcgByAG8AcgBfAHQAIABjAHUARABlAHYAaQBjAGUARwBlAHQATAB1AGkAZAAnACkAIAB7AAoAIAAgACAAIAAkAGMAbwBuAHQAZQBuAHQAIAA9ACAAJABjAG8AbgB0AGUAbgB0ACAAKwAgACIAYAByAGAAbgBgAHIAYABuAGgAaQBwAEUAcgByAG8AcgBfAHQAIABjAHUARABlAHYAaQBjAGUARwBlAHQATAB1AGkAZAAoAGMAaABhAHIAIAAqAGwAdQBpAGQALAAgAHUAbgBzAGkAZwBuAGUAZAAgAGkAbgB0ACAAKgBkAGUAdgBpAGMAZQBOAG8AZABlAE0AYQBzAGsALAAgAGgAaQBwAEQAZQB2AGkAYwBlAF8AdAAgAGQAZQB2ACkAOwBgAHIAYABuACIACgAgACAAIAAgAFMAZQB0AC0AQwBvAG4AdABlAG4AdAAgACQAZgBpAGwAZQAgACQAYwBvAG4AdABlAG4AdAAgAC0ATgBvAE4AZQB3AGwAaQBuAGUACgB9AAoA

REM ---- Compile each source to an object file ----
echo.
echo Compiling...
set HIP_SRC_PATH=%CD%\hip_src
if not exist comfy_aimdo mkdir comfy_aimdo
if not exist obj mkdir obj

REM ---- Visual Studio Path Prompt ----
echo Enter the path to your Visual Studio installation directory.
echo This is the folder containing the 'VC' folder, e.g.:
echo   C:\Program Files\Microsoft Visual Studio\2022\Community
echo.
set /p VS_PATH="Visual Studio Path: "

if not exist "%VS_PATH%\VC\Tools\MSVC\" (
    echo ERROR: Visual Studio path invalid or MSVC tools missing: %VS_PATH%
    exit /b 1
)

echo Found VS at: %VS_PATH% 

REM ---- Auto-detect MSVC Version ----
set MSVC_VER=
for /f "delims=" %%i in ('dir /b /ad /on "%VS_PATH%\VC\Tools\MSVC\"') do set MSVC_VER=%%i
set "MSVC_VER_PATH=%VS_PATH%\VC\Tools\MSVC\%MSVC_VER%" 

REM ---- Auto-detect Windows SDK (Checking D: then C:) ----
set "WINSDK_BASE="
if exist "D:\Program Files (x86)\Windows Kits\10" set "WINSDK_BASE=D:\Program Files (x86)\Windows Kits\10"
if not defined WINSDK_BASE if exist "C:\Program Files (x86)\Windows Kits\10" set "WINSDK_BASE=C:\Program Files (x86)\Windows Kits\10"
if not defined WINSDK_BASE if exist "D:\Program Files\Windows Kits\10" set "WINSDK_BASE=D:\Program Files\Windows Kits\10"
if not defined WINSDK_BASE if exist "C:\Program Files\Windows Kits\10" set "WINSDK_BASE=C:\Program Files\Windows Kits\10"

if not defined WINSDK_BASE (
    echo ERROR: Windows SDK 10 not found.
    exit /b 1
)

set WINSDK_VER=
for /f "delims=" %%i in ('dir /b /ad /on "%WINSDK_BASE%\Include\"') do set WINSDK_VER=%%i
set "WINSDK_INC_PATH=%WINSDK_BASE%\Include\%WINSDK_VER%"
set "WINSDK_LIB_PATH=%WINSDK_BASE%\Lib\%WINSDK_VER%"

echo Found WinSDK at: %WINSDK_BASE% (%WINSDK_VER%)

set "COMPILE_FLAGS=-D__HIP_PLATFORM_AMD__ -O3 -fms-extensions -fms-compatibility -I"%HIP_SRC_PATH%" -I"%HIP_INCLUDE%" -isystem "%CLANG_RESOURCE_DIR%\include" -isystem "%MSVC_VER_PATH%\include" -isystem "%WINSDK_INC_PATH%\ucrt" -isystem "%WINSDK_INC_PATH%\shared" -isystem "%WINSDK_INC_PATH%\um""

set OBJ_FILES=
for %%f in (hip_src\*.c) do (
    echo Compiling %%f...
    "%CLANG_EXE%" %COMPILE_FLAGS% -c "%%f" -o "obj\%%~nf.obj"
    if errorlevel 1 (
        echo COMPILE ERROR in %%f
        goto :buildfailed
    )
    set "OBJ_FILES=!OBJ_FILES! "obj\%%~nf.obj""
)

REM ---- Linking ----
echo.
echo Linking...
set "MSVC_LIB=%MSVC_VER_PATH%\lib\x64"

if exist comfy_aimdo\aimdo.dll del comfy_aimdo\aimdo.dll

"%LLDLINK_EXE%" ^
    -out:comfy_aimdo\aimdo.dll ^
    -dll ^
    -nologo ^
    "-libpath:%HIP_LIB%" ^
    "-libpath:%MSVC_LIB%" ^
    "-libpath:%WINSDK_LIB_PATH%\ucrt\x64" ^
    "-libpath:%WINSDK_LIB_PATH%\um\x64" ^
    "-libpath:%CLANG_RESOURCE_DIR%\lib\windows" ^
    "%CLANG_RESOURCE_DIR%\lib\windows\clang_rt.builtins-x86_64.lib" ^
    amdhip64.lib ^
    dxgi.lib ^
    dxguid.lib ^
    libcmt.lib ^
    %OBJ_FILES%

set BUILD_RESULT=%ERRORLEVEL%
if %BUILD_RESULT% neq 0 goto :buildfailed

REM ---- Patch comfy_aimdo\model_vbar.py ----
REM Overwrite with the fixed version that:
REM   1. Declares vbar_allocate with 3 args (size, device, pre_addr=NULL) so ctypes
REM      zeroes r8 on the Win64 call instead of leaving garbage that the DLL
REM      interprets as a pre-reserved address, corrupting the vbar struct.
REM   2. Calls control.init_device(device) before any hipMem* API -- without it,
REM      hipMemAddressReserve returns invalid argument for every size.
REM   3. Caps VBAR size to actual GPU VRAM on WDDM (hipMemAddressReserve is bounded
REM      by the driver budget, not arbitrary VA like on Linux) and retries with
REM      halving in case the budget is lower than total_memory reports.
echo Patching comfy_aimdo\model_vbar.py...
python -c "import base64; open('comfy_aimdo\\model_vbar.py','w',newline='\n').write(base64.b64decode('aW1wb3J0IGN0eXBlcwoKZnJvbSAuIGltcG9ydCBjb250cm9sCgpsaWIgPSBjb250cm9sLmxpYgoKIyBCaW5kaW5ncwppZiBsaWIgaXMgbm90IE5vbmU6CiAgICBsaWIudmJhcl9hbGxvY2F0ZS5hcmd0eXBlcyA9IFtjdHlwZXMuY191aW50NjQsIGN0eXBlcy5jX2ludCwgY3R5cGVzLmNfdm9pZF9wXSAgIyBwcmVfYWRkcj1OVUxMCiAgICBsaWIudmJhcl9hbGxvY2F0ZS5yZXN0eXBlID0gY3R5cGVzLmNfdm9pZF9wCgogICAgbGliLnZiYXJfc2V0X3dhdGVybWFya19saW1pdC5hcmd0eXBlcyA9IFtjdHlwZXMuY192b2lkX3AsIGN0eXBlcy5jX3VpbnQ2NF0KCiAgICBsaWIudmJhcnNfcmVzZXRfd2F0ZXJtYXJrX2xpbWl0cy5hcmd0eXBlcyA9IFtdCgogICAgbGliLnZiYXJfcHJpb3JpdGl6ZS5hcmd0eXBlcyA9IFtjdHlwZXMuY192b2lkX3BdCgogICAgbGliLnZiYXJfZGVwcmlvcml0aXplLmFyZ3R5cGVzID0gW2N0eXBlcy5jX3ZvaWRfcF0KCiAgICBsaWIudmJhcl9nZXQuYXJndHlwZXMgPSBbY3R5cGVzLmNfdm9pZF9wXQogICAgbGliLnZiYXJfZ2V0LnJlc3R5cGUgPSBjdHlwZXMuY191aW50NjQKCiAgICBsaWIudmJhcl9mcmVlLmFyZ3R5cGVzID0gW2N0eXBlcy5jX3ZvaWRfcF0KCiAgICBsaWIudmJhcl9mYXVsdC5hcmd0eXBlcyA9IFtjdHlwZXMuY192b2lkX3AsIGN0eXBlcy5jX3VpbnQ2NCwgY3R5cGVzLmNfdWludDY0LCBjdHlwZXMuUE9JTlRFUihjdHlwZXMuY191aW50MzIpXQogICAgbGliLnZiYXJfZmF1bHQucmVzdHlwZSA9IGN0eXBlcy5jX2ludAoKICAgIGxpYi52YmFyX3VucGluLmFyZ3R5cGVzID0gW2N0eXBlcy5jX3ZvaWRfcCwgY3R5cGVzLmNfdWludDY0LCBjdHlwZXMuY191aW50NjRdCgogICAgbGliLnZiYXJfbG9hZGVkX3NpemUuYXJndHlwZXMgPSBbY3R5cGVzLmNfdm9pZF9wXQogICAgbGliLnZiYXJfbG9hZGVkX3NpemUucmVzdHlwZSA9IGN0eXBlcy5jX3NpemVfdAoKICAgIGxpYi52YmFyX2ZyZWVfbWVtb3J5LmFyZ3R5cGVzID0gW2N0eXBlcy5jX3ZvaWRfcCwgY3R5cGVzLmNfdWludDY0XQogICAgbGliLnZiYXJfZnJlZV9tZW1vcnkucmVzdHlwZSA9IGN0eXBlcy5jX3VpbnQ2NAoKY2xhc3MgTW9kZWxWQkFSOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHNpemUsIGRldmljZSk6CiAgICAgICAgIyBFbnN1cmUgdGhlIERMTCdzIEhJUCBydW50aW1lIGlzIGluaXRpYWxpemVkIGZvciB0aGlzIGRldmljZS4KICAgICAgICAjIGNvbnRyb2wuaW5pdCgpIG9ubHkgbG9hZHMgdGhlIERMTDsgbGliLmluaXQoZGV2aWNlX2lkKSBtdXN0IGFsc28gYmUKICAgICAgICAjIGNhbGxlZCBiZWZvcmUgYW55IGhpcE1lbSogQVBJIChpbmNsdWRpbmcgaGlwTWVtQWRkcmVzc1Jlc2VydmUpIHdpbGwgd29yay4KICAgICAgICBpZiBub3QgY29udHJvbC5pbml0X2RldmljZShkZXZpY2UpOgogICAgICAgICAgICByYWlzZSBSdW50aW1lRXJyb3IoZiJGYWlsZWQgdG8gaW5pdGlhbGl6ZSBhaW1kbyBmb3IgZGV2aWNlIHtkZXZpY2V9IikKCiAgICAgICAgIyBPbiBXRERNIFdpbmRvd3MsIGhpcE1lbUFkZHJlc3NSZXNlcnZlIGlzIGJvdW5kZWQgYnkgdGhlIGRyaXZlciBtZW1vcnkKICAgICAgICAjIGJ1ZGdldCwgbm90IHRoZSBmdWxsIHZpcnR1YWwgYWRkcmVzcyBzcGFjZSBsaWtlIG9uIExpbnV4LiBDYXAgdG8gYWN0dWFsCiAgICAgICAgIyBWUkFNIHNvIGNhbGxlcnMgZG9uJ3QgbmVlZCB0byBrbm93IHRoZSBHUFUgc2l6ZSwgYW5kIHJldHJ5IHdpdGggaGFsdmluZwogICAgICAgICMgaW4gY2FzZSB0aGUgYnVkZ2V0IGlzIGxvd2VyIHRoYW4gdG90YWxfbWVtb3J5IHJlcG9ydHMuCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgdG9yY2gKICAgICAgICAgICAgdnJhbV90b3RhbCA9IHRvcmNoLmN1ZGEuZ2V0X2RldmljZV9wcm9wZXJ0aWVzKGRldmljZSkudG90YWxfbWVtb3J5CiAgICAgICAgICAgIHNpemUgPSBtaW4oaW50KHNpemUpLCB2cmFtX3RvdGFsKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHNpemUgPSBpbnQoc2l6ZSkKCiAgICAgICAgc2VsZi5fcHRyID0gTm9uZQogICAgICAgIGF0dGVtcHQgPSBpbnQoc2l6ZSkKICAgICAgICB3aGlsZSBhdHRlbXB0ID49ICgzMiA8PCAyMCk6ICAjIGRvbid0IGdvIGJlbG93IG9uZSBWQkFSIHBhZ2UgKDMyIE1CKQogICAgICAgICAgICBzZWxmLl9wdHIgPSBsaWIudmJhcl9hbGxvY2F0ZShhdHRlbXB0LCBkZXZpY2UsIE5vbmUpCiAgICAgICAgICAgIGlmIHNlbGYuX3B0cjoKICAgICAgICAgICAgICAgIHNpemUgPSBhdHRlbXB0CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBhdHRlbXB0IC8vPSAyCgogICAgICAgIGlmIG5vdCBzZWxmLl9wdHI6CiAgICAgICAgICAgIHJhaXNlIE1lbW9yeUVycm9yKCJWQkFSIGFsbG9jYXRpb24gZmFpbGVkIikKCiAgICAgICAgc2VsZi5kZXZpY2UgPSBkZXZpY2UKICAgICAgICBzZWxmLm1heF9zaXplID0gc2l6ZQogICAgICAgIHNlbGYub2Zmc2V0ID0gMAogICAgICAgIHNlbGYuYmFzZV9hZGRyID0gbGliLnZiYXJfZ2V0KHNlbGYuX3B0cikKCiAgICBkZWYgcHJpb3JpdGl6ZShzZWxmKToKICAgICAgICBsaWIudmJhcl9wcmlvcml0aXplKHNlbGYuX3B0cikKCiAgICBkZWYgZGVwcmlvcml0aXplKHNlbGYpOgogICAgICAgIGxpYi52YmFyX2RlcHJpb3JpdGl6ZShzZWxmLl9wdHIpCgogICAgZGVmIGFsbG9jKHNlbGYsIG51bV9ieXRlcyk6CiAgICAgICAgc2VsZi5vZmZzZXQgPSAoc2VsZi5vZmZzZXQgKyA1MTEpICYgfjUxMQoKICAgICAgICBpZiBzZWxmLm9mZnNldCArIG51bV9ieXRlcyA+IHNlbGYubWF4X3NpemU6CiAgICAgICAgICAgIHJhaXNlIE1lbW9yeUVycm9yKCJWQkFSIE9PTSIpCgogICAgICAgIGFsbG9jID0gc2VsZi5iYXNlX2FkZHIgKyBzZWxmLm9mZnNldAogICAgICAgIHNlbGYub2Zmc2V0ICs9IG51bV9ieXRlcwogICAgICAgIHJldHVybiAoc2VsZiwgYWxsb2MsIG51bV9ieXRlcykKCiAgICAjZGVmaW5lIFZCQVJfUEFHRV9TSVpFICgzMiA8PCAyMCkKCiAgICAjZGVmaW5lIFZCQVJfRkFVTFRfU1VDQ0VTUyAgICAgIDAKICAgICNkZWZpbmUgVkJBUl9GQVVMVF9PT00gICAgICAgICAgMQogICAgI2RlZmluZSBWQkFSX0ZBVUxUX0VSUk9SICAgICAgICAyCgogICAgZGVmIGZhdWx0KHNlbGYsIGFsbG9jLCBzaXplKToKICAgICAgICBvZmZzZXQgPSBhbGxvYyAtIHNlbGYuYmFzZV9hZGRyCiAgICAgICAgIyArMiwgb25lIGZvciBtaXNhbGlnbm1lbnQgYW5kIG9uZSBmb3Igcm91bmRpbmcKICAgICAgICBzaWduYXR1cmUgPSAoY3R5cGVzLmNfdWludDMyICogKHNpemUgLy8gKDMyICogMTAyNCAqKiAyKSArIDIpKSgpCiAgICAgICAgcmVzID0gbGliLnZiYXJfZmF1bHQoc2VsZi5fcHRyLCBvZmZzZXQsIHNpemUsIHNpZ25hdHVyZSkKICAgICAgICBpZiByZXMgPT0gMDoKICAgICAgICAgICAgcmV0dXJuIHNpZ25hdHVyZQogICAgICAgIGVsaWYgcmVzID09IDE6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgUnVudGltZUVycm9yKGYiRmF1bHQgZmFpbGVkOiB7cmVzfSIpCgogICAgZGVmIHVucGluKHNlbGYsIGFsbG9jLCBzaXplKToKICAgICAgICBvZmZzZXQgPSBhbGxvYyAtIHNlbGYuYmFzZV9hZGRyCiAgICAgICAgbGliLnZiYXJfdW5waW4oc2VsZi5fcHRyLCBvZmZzZXQsIHNpemUpCgogICAgZGVmIGxvYWRlZF9zaXplKHNlbGYpOgogICAgICAgIHJldHVybiBsaWIudmJhcl9sb2FkZWRfc2l6ZShzZWxmLl9wdHIpCgogICAgZGVmIHNldF93YXRlcm1hcmtfbGltaXQoc2VsZiwgc2l6ZV9ieXRlcyk6CiAgICAgICAgbGliLnZiYXJfc2V0X3dhdGVybWFya19saW1pdChzZWxmLl9wdHIsIHNpemVfYnl0ZXMpCgogICAgZGVmIGZyZWVfbWVtb3J5KHNlbGYsIHNpemVfYnl0ZXMpOgogICAgICAgIHJldHVybiBsaWIudmJhcl9mcmVlX21lbW9yeShzZWxmLl9wdHIsIGludChzaXplX2J5dGVzKSkKCiAgICBkZWYgX19kZWxfXyhzZWxmKToKICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICdfcHRyJykgYW5kIHNlbGYuX3B0cjoKICAgICAgICAgICAgbGliLnZiYXJfZnJlZShzZWxmLl9wdHIpCiAgICAgICAgICAgIHNlbGYuX3B0ciA9IE5vbmUKCmRlZiB2YmFyX2ZhdWx0KGFsbG9jKToKICAgIHZiYXIsIG9mZnNldCwgc2l6ZSA9IGFsbG9jCiAgICByZXR1cm4gdmJhci5mYXVsdChvZmZzZXQsIHNpemUpCgpkZWYgdmJhcl91bnBpbihhbGxvYyk6CiAgICBpZiBhbGxvYyBpcyBub3QgTm9uZToKICAgICAgICB2YmFyLCBvZmZzZXQsIHNpemUgPSBhbGxvYwogICAgICAgIHZiYXIudW5waW4ob2Zmc2V0LCBzaXplKQoKZGVmIHZiYXJfc2lnbmF0dXJlX2NvbXBhcmUoYSwgYik6CiAgICBpZiBhIGlzIE5vbmUgb3IgYiBpcyBOb25lOgogICAgICAgIHJldHVybiBGYWxzZQogICAgaWYgbGVuKGEpICE9IGxlbihiKToKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiU2lnbmF0dXJlcyBvZiBtaXNtYXRjaGVkIGxlbmd0aCB7bGVuKGEpfSAhPSB7bGVuKGIpfSIpCiAgICByZXR1cm4gbWVtb3J5dmlldyhhKSA9PSBtZW1vcnl2aWV3KGIpCgpkZWYgdmJhcnNfcmVzZXRfd2F0ZXJtYXJrX2xpbWl0cygpOgogICAgbGliLnZiYXJzX3Jlc2V0X3dhdGVybWFya19saW1pdHMoKQo=').decode())"
if %errorlevel% neq 0 (
    echo ERROR: Failed to patch model_vbar.py
    goto :buildfailed
)
echo   model_vbar.py patched OK.

goto :cleanup

:buildfailed
set BUILD_RESULT=1

:cleanup
if exist "%CUDA_LINK%" rmdir "%CUDA_LINK%"
if exist obj rmdir /S /Q obj

echo.
if %BUILD_RESULT% EQU 0 (
    if exist comfy_aimdo\aimdo.dll (
        echo ============================================
        echo          BUILD SUCCESSFUL
        echo ============================================
        echo Output: comfy_aimdo\aimdo.dll
        for %%F in (comfy_aimdo\aimdo.dll) do echo Size:   %%~zF bytes
        echo.
        echo Now run: pip install .
		echo.
		echo After that, one manual step:
        for /f "tokens=*" %%i in ('python -c "import site; print(site.getsitepackages()[0])"') do set "VENV_SITE=%%i"
        echo Copy %ROCM_PATH%\bin\amdhip64_7.dll
        echo   to !VENV_SITE!\Lib\site-packages\comfy_aimdo\
        echo   Without this it may use the system-wide version or fail to
        echo   load entirely because the dependency cannot be resolved
        echo   from within the virtual environment.
        echo ============================================
    ) else (
        echo ============================================
        echo BUILD FAILED - DLL not produced
        echo ============================================
        exit /b 1
    )
) else (
    echo ============================================
    echo BUILD FAILED - error code %BUILD_RESULT%
    echo ============================================
    exit /b %BUILD_RESULT%
)